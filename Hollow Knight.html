<!DOCTYPE html>
<html lang="en-us">
<head>
<base href="https://cdn.jsdelivr.net/gh/aukak/hollow-knight@latest/">
<meta charset="utf-8">
<title>Hollow Knight</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{background:#000;overflow:hidden}#loading-text{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font:24px Arial;z-index:10}#unity-canvas{width:100vw;height:100vh;display:block}#fps-graph{position:fixed;top:10px;left:10px;width:80px;height:30px;background:rgba(0,0,0,.7);border-radius:4px;z-index:9999;display:none}#fps-canvas{width:100%;height:100%;display:block}
</style>
</head>
<body>
<div id="loading-text">truffed.lol</div>
<canvas id="unity-canvas"></canvas>
<div id="fps-graph"><canvas id="fps-canvas"></canvas></div>
  
<script>
const lt=document.getElementById("loading-text"),cv=document.getElementById("unity-canvas"),fg=document.getElementById("fps-graph"),fc=document.getElementById("fps-canvas");
let lb=0;const tm='912.81';fc.width=80;fc.height=30;const ctx=fc.getContext('2d');let lft=performance.now(),fr=0,fps=60;

function uf(){
    const nt=performance.now(),dt=(nt-lft)/1000;lft=nt;fps=dt>0?1/dt:60;fr++;
    if(fr%5===0){
        ctx.clearRect(0,0,80,30);ctx.fillStyle='#fff';ctx.font='bold 12px monospace';
        ctx.fillText(Math.round(fps)+' FPS',10,20);
    }
    requestAnimationFrame(uf);
}

async function fwp(u){
    const r=await fetch(u),rd=r.body.getReader(),ch=[];
    while(true){
        const{done,value}=await rd.read();if(done)break;
        lb+=value.length;ch.push(value);
        lt.textContent=`${(lb/1048576).toFixed(2)} MB / ${tm} MB`;
    }
    return new Blob(ch);
}

async function mf(p, mime){
    const blobs = await Promise.all(p.map(fwp));
    return URL.createObjectURL(new Blob(blobs, { type: mime }));
}

function gp(f,s,e){return Array.from({length:e-s+1},(_,i)=>`${f}.part${s+i}`);}

(async()=>{
    try {
        const [du, wu] = await Promise.all([
            mf(gp("Build/hktruffled.data", 1, 45), "application/octet-stream"),
            mf(gp("Build/hktruffled.wasm", 1, 2), "application/wasm")
        ]);

        const sc=document.createElement("script");
        sc.src="Build/hktruffled.loader.js";
        sc.onload=()=>{
            createUnityInstance(cv,{
                dataUrl:du,
                frameworkUrl:"Build/hktruffled.framework.js",
                codeUrl:wu,
                streamingAssetsUrl:"StreamingAssets",
                companyName:"Team Cherry",
                productName:"Hollow Knight",
                productVersion:"1.0"
            }).then(()=>{
                lt.remove();fg.style.display='block';uf();
            }).catch(console.error);
        };
        document.body.appendChild(sc);
    } catch (e) {
        console.error("Load failed:", e);
    }
})();
</script>
</body>
</html>
